<!doctype html>
<html lang="en">
  <head>
    <title>ESP32Tool</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Flash & Read ESP devices using WebSerial and WebUSB" />
    <meta name="theme-color" content="#1a1a1a" />
    <link rel="manifest" href="manifest.json" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="ESP32Tool" />
    <link rel="apple-touch-icon" href="icons/icon-192.png" />
    <script>
      // Redirect to HTTPS if HTTP is requested.
      if (
        window.location.hostname !== "localhost" &&
        window.location.protocol === "http:"
      ) {
        window.location.href = "https:" + window.location.href.substring(5);
      }
    </script>

    <!-- import the web page's stylesheets along with the themes -->
    <link rel="stylesheet" href="css/style.css" />
    <link
      rel="stylesheet"
      href="css/light.css"
      id="light"
      class="alternate"
      disabled
    />
    <link
      rel="stylesheet"
      href="css/dark.css"
      id="dark"
      class="alternate"
      disabled
    />

    <!-- import the webpage's javascript file -->
    <script type="module">
      window.esptoolPackage = import(
        // In development we import locally.
        window.location.hostname === "localhost"
          ? "./js/modules/esptool.js"
          : "./js/modules/esptool.js"
      );
    </script>
    <script src="js/script.js?v=2.0.2" type="module" defer></script>
    
    <!-- PWA Service Worker Registration - DISABLED FOR TESTING -->
    <script>
      // Service Worker disabled for testing - always load fresh files
      console.log('[PWA] Service Worker DISABLED for testing');
      /*
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then((registration) => {
              console.log('[PWA] Service Worker registered:', registration.scope);
              
              // Check for updates
              registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                newWorker.addEventListener('statechange', () => {
                  if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    console.log('[PWA] New version available! Reload to update.');
                  }
                });
              });
            })
            .catch((error) => {
              console.log('[PWA] Service Worker registration failed:', error);
            });
        });
      }
      */
    </script>
  </head>
  <body>
    <header class="header">
      <div class="header-content">
        <button id="butConnect" type="button">Connect</button>
        <select id="baudRate"></select>
        
        <label for="showlog">Show Log</label>
        <div class="onoffswitch">
          <input
            type="checkbox"
            name="showlog"
            class="onoffswitch-checkbox"
            id="showlog"
          />
          <label class="onoffswitch-label" for="showlog">
            <span class="onoffswitch-inner"></span>
            <span class="onoffswitch-switch"></span>
          </label>
        </div>

        <span class="log-controls">
          <label for="autoscroll">Autoscroll</label>
          <div class="onoffswitch">
            <input
              type="checkbox"
              name="autoscroll"
              class="onoffswitch-checkbox"
              id="autoscroll"
            />
            <label class="onoffswitch-label" for="autoscroll">
              <span class="onoffswitch-inner"></span>
              <span class="onoffswitch-switch"></span>
            </label>
          </div>
          <button id="butClear" type="button" class="small-btn">
            Clear
          </button>
        </span>

        <label for="debugmode">Debug</label>
        <div class="onoffswitch">
          <input
            type="checkbox"
            name="debugmode"
            class="onoffswitch-checkbox"
            id="debugmode"
          />
          <label class="onoffswitch-label" for="debugmode">
            <span class="onoffswitch-inner"></span>
            <span class="onoffswitch-switch"></span>
          </label>
        </div>

        <label for="darkmode">Dark</label>
        <div class="onoffswitch">
          <input
            type="checkbox"
            name="darkmode"
            class="onoffswitch-checkbox"
            id="darkmode"
          />
          <label class="onoffswitch-label" for="darkmode">
            <span class="onoffswitch-inner"></span>
            <span class="onoffswitch-switch"></span>
          </label>
        </div>
      </div>
    </header>
    <main class="main">
      <div id="notSupported" class="notSupported">
        Sorry, <b>Web Serial</b> or <b>WebUSB</b> is not supported on this device. 
        Make sure you're running Chrome 89 or later (Desktop) or Chrome 61+ (Android with USB OTG).
      </div>
      <div id="app">
        <div id="commands">
          <div class="upload">
            <label
              >Offset: 0x
              <input class="offset" type="text" value="0" />
            </label>
            <label class="firmware">
              <input type="file" accept=".bin" />
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="17"
                viewbox="0 0 20 17"
              >
                <path
                  d="M10 0l-5.2 4.9h3.3v5.1h3.8v-5.1h3.3l-5.2-4.9zm9.3 11.5l-3.2-2.1h-2l3.4 2.6h-3.5c-.1 0-.2.1-.2.1l-.8 2.3h-6l-.8-2.2c-.1-.1-.1-.2-.2-.2h-3.6l3.4-2.6h-2l-3.2 2.1c-.4.3-.7 1-.6 1.5l.6 3.1c.1.5.7.9 1.2.9h16.3c.6 0 1.1-.4 1.3-.9l.6-3.1c.1-.5-.2-1.2-.7-1.5z"
                />
              </svg>
              <span>Choose a file&hellip;</span>
            </label>
            <div class="progress-bar hidden"><div></div></div>
          </div>
          <div class="upload">
            <label
              >Offset: 0x
              <input class="offset" type="text" value="0" />
            </label>
            <label class="firmware">
              <input type="file" accept=".bin" />
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="17"
                viewbox="0 0 20 17"
              >
                <path
                  d="M10 0l-5.2 4.9h3.3v5.1h3.8v-5.1h3.3l-5.2-4.9zm9.3 11.5l-3.2-2.1h-2l3.4 2.6h-3.5c-.1 0-.2.1-.2.1l-.8 2.3h-6l-.8-2.2c-.1-.1-.1-.2-.2-.2h-3.6l3.4-2.6h-2l-3.2 2.1c-.4.3-.7 1-.6 1.5l.6 3.1c.1.5.7.9 1.2.9h16.3c.6 0 1.1-.4 1.3-.9l.6-3.1c.1-.5-.2-1.2-.7-1.5z"
                />
              </svg>
              <span>Choose a file&hellip;</span>
            </label>
            <div class="progress-bar hidden"><div></div></div>
          </div>
          <div class="upload">
            <label
              >Offset: 0x
              <input class="offset" type="text" value="0" />
            </label>
            <label class="firmware">
              <input type="file" accept=".bin" />
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="17"
                viewbox="0 0 20 17"
              >
                <path
                  d="M10 0l-5.2 4.9h3.3v5.1h3.8v-5.1h3.3l-5.2-4.9zm9.3 11.5l-3.2-2.1h-2l3.4 2.6h-3.5c-.1 0-.2.1-.2.1l-.8 2.3h-6l-.8-2.2c-.1-.1-.1-.2-.2-.2h-3.6l3.4-2.6h-2l-3.2 2.1c-.4.3-.7 1-.6 1.5l.6 3.1c.1.5.7.9 1.2.9h16.3c.6 0 1.1-.4 1.3-.9l.6-3.1c.1-.5-.2-1.2-.7-1.5z"
                />
              </svg>
              <span>Choose a file&hellip;</span>
            </label>
            <div class="progress-bar hidden"><div></div></div>
          </div>
          <div class="upload">
            <label
              >Offset: 0x
              <input class="offset" type="text" value="0" />
            </label>
            <label class="firmware">
              <input type="file" accept=".bin" />
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="17"
                viewbox="0 0 20 17"
              >
                <path
                  d="M10 0l-5.2 4.9h3.3v5.1h3.8v-5.1h3.3l-5.2-4.9zm9.3 11.5l-3.2-2.1h-2l3.4 2.6h-3.5c-.1 0-.2.1-.2.1l-.8 2.3h-6l-.8-2.2c-.1-.1-.1-.2-.2-.2h-3.6l3.4-2.6h-2l-3.2 2.1c-.4.3-.7 1-.6 1.5l.6 3.1c.1.5.7.9 1.2.9h16.3c.6 0 1.1-.4 1.3-.9l.6-3.1c.1-.5-.2-1.2-.7-1.5z"
                />
              </svg>
              <span>Choose a file&hellip;</span>
            </label>
            <div class="progress-bar hidden"><div></div></div>
          </div>
          <div class="upload">
            <label
              >Offset: 0x
              <input class="offset" type="text" value="0" />
            </label>
            <label class="firmware">
              <input type="file" accept=".bin" />
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="17"
                viewbox="0 0 20 17"
              >
                <path
                  d="M10 0l-5.2 4.9h3.3v5.1h3.8v-5.1h3.3l-5.2-4.9zm9.3 11.5l-3.2-2.1h-2l3.4 2.6h-3.5c-.1 0-.2.1-.2.1l-.8 2.3h-6l-.8-2.2c-.1-.1-.1-.2-.2-.2h-3.6l3.4-2.6h-2l-3.2 2.1c-.4.3-.7 1-.6 1.5l.6 3.1c.1.5.7.9 1.2.9h16.3c.6 0 1.1-.4 1.3-.9l.6-3.1c.1-.5-.2-1.2-.7-1.5z"
                />
              </svg>
              <span>Choose a file&hellip;</span>
            </label>
            <div class="progress-bar hidden"><div></div></div>
          </div>
          <div class="upload">
            <label
              >Offset: 0x
              <input class="offset" type="text" value="0" />
            </label>
            <label class="firmware">
              <input type="file" accept=".bin" />
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="17"
                viewbox="0 0 20 17"
              >
                <path
                  d="M10 0l-5.2 4.9h3.3v5.1h3.8v-5.1h3.3l-5.2-4.9zm9.3 11.5l-3.2-2.1h-2l3.4 2.6h-3.5c-.1 0-.2.1-.2.1l-.8 2.3h-6l-.8-2.2c-.1-.1-.1-.2-.2-.2h-3.6l3.4-2.6h-2l-3.2 2.1c-.4.3-.7 1-.6 1.5l.6 3.1c.1.5.7.9 1.2.9h16.3c.6 0 1.1-.4 1.3-.9l.6-3.1c.1-.5-.2-1.2-.7-1.5z"
                />
              </svg>
              <span>Choose a file&hellip;</span>
            </label>
            <div class="progress-bar hidden"><div></div></div>
          </div>
          <div class="upload">
            <label
              >Offset: 0x
              <input class="offset" type="text" value="0" />
            </label>
            <label class="firmware">
              <input type="file" accept=".bin" />
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="17"
                viewbox="0 0 20 17"
              >
                <path
                  d="M10 0l-5.2 4.9h3.3v5.1h3.8v-5.1h3.3l-5.2-4.9zm9.3 11.5l-3.2-2.1h-2l3.4 2.6h-3.5c-.1 0-.2.1-.2.1l-.8 2.3h-6l-.8-2.2c-.1-.1-.1-.2-.2-.2h-3.6l3.4-2.6h-2l-3.2 2.1c-.4.3-.7 1-.6 1.5l.6 3.1c.1.5.7.9 1.2.9h16.3c.6 0 1.1-.4 1.3-.9l.6-3.1c.1-.5-.2-1.2-.7-1.5z"
                />
              </svg>
              <span>Choose a file&hellip;</span>
            </label>
            <div class="progress-bar hidden"><div></div></div>
          </div>
          <div class="upload">
            <label
              >Offset: 0x
              <input class="offset" type="text" value="0" />
            </label>
            <label class="firmware">
              <input type="file" accept=".bin" />
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="17"
                viewbox="0 0 20 17"
              >
                <path
                  d="M10 0l-5.2 4.9h3.3v5.1h3.8v-5.1h3.3l-5.2-4.9zm9.3 11.5l-3.2-2.1h-2l3.4 2.6h-3.5c-.1 0-.2.1-.2.1l-.8 2.3h-6l-.8-2.2c-.1-.1-.1-.2-.2-.2h-3.6l3.4-2.6h-2l-3.2 2.1c-.4.3-.7 1-.6 1.5l.6 3.1c.1.5.7.9 1.2.9h16.3c.6 0 1.1-.4 1.3-.9l.6-3.1c.1-.5-.2-1.2-.7-1.5z"
                />
              </svg>
              <span>Choose a file&hellip;</span>
            </label>
            <div class="progress-bar hidden"><div></div></div>
          </div>
          <div class="buttons">
            <button id="butErase" type="button" disabled="disabled">
              Erase
            </button>
            <button id="butProgram" type="button" disabled="disabled">
              Program
            </button>
          </div>
          <div class="partition-table">
            <button id="butReadPartitions" type="button" disabled="disabled">
              Read Partition Table
            </button>
            <button id="butDetectFS" type="button" class="hidden">
              Detect FS and Open Manager
            </button>
            <button id="butOpenFSManager" type="button" class="hidden">
              Open FS Manager
            </button>
            <div class="progress-bar hidden" id="partitionProgress">
              <div></div>
            </div>
            <div id="partitionList" class="hidden"></div>
          </div>
          <div class="read-flash">
            <div class="progress-bar hidden" id="readProgress"><div></div></div>
            <div class="read-flash-inputs">
              <label>
                Address: 0x
                <input id="readOffset" type="text" value="0" />
              </label>
              <label>
                Size: 0x
                <input id="readSize" type="text" value="1000" />
              </label>
              <button id="butReadFlash" type="button" disabled="disabled">
                Read Flash
              </button>
            </div>
          </div>
        </div>
        <div id="littlefsManager" class="littlefs-manager hidden">
          <h3>Filesystem Manager</h3>
          <div class="littlefs-info">
            <div class="littlefs-partition-info">
              <strong>Partition:</strong> <span id="littlefsPartitionName">-</span>
              <span class="littlefs-size">(<span id="littlefsPartitionSize">-</span>)</span>
            </div>
            <div class="littlefs-usage">
              <div class="usage-bar">
                <div id="littlefsUsageBar" class="usage-fill" style="width: 0%"></div>
              </div>
              <div class="usage-text">
                <span id="littlefsUsageText">Used: 0 B / 0 B (0%)</span>
                <span id="littlefsDiskVersion" class="disk-version"></span>
              </div>
            </div>
          </div>
          <div class="littlefs-controls">
            <button id="butLittlefsRefresh" type="button">
              Refresh
            </button>
            <button id="butLittlefsBackup" type="button">
              Backup Image
            </button>
            <button id="butLittlefsWrite" type="button">
              Write to Flash
            </button>
            <button id="butLittlefsClose" type="button">
              Close
            </button>
          </div>
          <div class="littlefs-breadcrumb">
            <button id="butLittlefsUp" type="button" disabled="disabled">
              ↑ Up
            </button>
            <span id="littlefsBreadcrumb">/</span>
          </div>
          <div class="littlefs-file-upload">
            <input type="file" id="littlefsFileInput" />
            <button id="butLittlefsUpload" type="button" disabled="disabled">
              Upload File
            </button>
            <button id="butLittlefsMkdir" type="button">
              New Folder
            </button>
          </div>
          <div class="littlefs-files">
            <table id="littlefsFileTable" class="file-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Type</th>
                  <th>Size</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="littlefsFileList">
                <tr>
                  <td colspan="4" class="empty-state">No files loaded</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div id="log"></div>
      </div>
    </main>

    <!-- ESP32-S2 Reconnect Modal -->
    <div id="esp32s2Modal" class="modal hidden">
      <div class="modal-content">
        <h2>ESP32-S2 has switched to USB CDC mode</h2>
        <p>Please click the button below to select the new serial port.</p>
        <button id="butReconnectS2" type="button" class="modal-button">
          Select New Port
        </button>
      </div>
    </div>

    <!-- File Viewer Modal -->
    <div id="fileViewerModal" class="modal hidden">
      <div class="modal-content file-viewer-content">
        <div class="file-viewer-header">
          <h2 id="fileViewerTitle">File Viewer</h2>
          <button id="butCloseFileViewer" type="button" class="close-button">✕</button>
        </div>
        <div class="file-viewer-info">
          <span id="fileViewerPath"></span>
          <span id="fileViewerSize"></span>
        </div>
        <div class="file-viewer-tabs">
          <button id="tabText" class="tab-button active" type="button">Text</button>
          <button id="tabHex" class="tab-button" type="button">Hex</button>
        </div>
        <div id="fileViewerContent" class="file-viewer-body">
          <pre id="fileViewerText"></pre>
        </div>
        <div class="file-viewer-footer">
          <button id="butDownloadFromViewer" type="button" class="modal-button">
            Download
          </button>
        </div>
      </div>
    </div>

    <footer class="footer"></footer>
  </body>
</html>
